# 核心服务

<cite>
**本文档中引用的文件**  
- [task.proto](file://proto/cline/task.proto)
- [file.proto](file://proto/cline/file.proto)
- [state.proto](file://proto/cline/state.proto)
- [models.proto](file://proto/cline/models.proto)
- [checkpoints.proto](file://proto/cline/checkpoints.proto)
- [common.proto](file://proto/cline/common.proto)
</cite>

## 目录
1. [简介](#简介)
2. [核心gRPC服务概览](#核心grpc服务概览)
3. [TaskService 服务详解](#taskservice-服务详解)
4. [FileService 服务详解](#fileservice-服务详解)
5. [StateService 服务详解](#stateservice-服务详解)
6. [ModelsService 服务详解](#modelsservice-服务详解)
7. [CheckpointsService 服务详解](#checkpointsservice-服务详解)
8. [服务协同工作流程](#服务协同工作流程)
9. [TypeScript 调用示例](#typescript-调用示例)
10. [附录：核心消息类型](#附录核心消息类型)

## 简介
本文档为Cline的核心gRPC服务提供详细的API参考。重点涵盖在`task.proto`、`file.proto`、`state.proto`、`models.proto`和`checkpoints.proto`中定义的服务。文档详细说明了各服务的方法、请求/响应消息的字段及其生命周期，并提供TypeScript调用示例，以展示这些服务如何协同执行复杂的开发任务。

## 核心gRPC服务概览
Cline的核心功能通过一组gRPC服务暴露，这些服务允许客户端与Cline的内部功能进行交互。主要服务包括：
- **TaskService**: 管理任务的创建、执行、状态查询和历史记录。
- **FileService**: 处理文件的读取、写入、列出和操作。
- **StateService**: 获取和更新Cline的全局状态和用户设置。
- **ModelsService**: 管理可用的AI模型列表和API配置。
- **CheckpointsService**: 创建和恢复开发过程中的检查点。

这些服务共同构成了Cline自动化开发能力的基础。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L1-L116)
- [file.proto](file://proto/cline/file.proto#L1-L186)
- [state.proto](file://proto/cline/state.proto#L1-L290)
- [models.proto](file://proto/cline/models.proto#L1-L349)
- [checkpoints.proto](file://proto/cline/checkpoints.proto#L1-L18)

## TaskService 服务详解
`TaskService`是Cline中用于管理用户任务的核心服务。它负责任务的生命周期，从创建到执行再到状态监控。

### ExecuteTask (流式) 方法
尽管在`task.proto`中未直接定义名为`ExecuteTask`的流式方法，但其功能由`newTask`方法和`subscribeToState`流共同实现。`newTask`方法启动一个新任务，而任务的执行状态和更新通过`StateService`的流式接口进行推送。

#### 请求消息: NewTaskRequest
该消息用于创建并启动一个新任务。
- `metadata`: [Metadata](file://proto/cline/common.proto#L10-L12) - 通用元数据。
- `text`: string - 任务的文本描述或指令。
- `images`: repeated string - 与任务关联的图像数据URL列表。
- `files`: repeated string - 与任务关联的文件路径列表。

#### 响应消息: 无直接响应
`newTask`方法返回`Empty`，表示请求已成功接收。任务的实际执行状态和更新通过`StateService`的`subscribeToState`流式方法提供。

#### 生命周期
1. 客户端调用`newTask(NewTaskRequest)`。
2. Cline后端接收请求并开始处理任务。
3. 任务的实时状态更新（如进度、中间结果）通过`StateService.subscribeToState()`的流式响应持续发送。
4. 任务完成后，最终状态和结果通过流式消息发送。

### GetTaskStatus 方法
`GetTaskStatus`的功能由`getTaskHistory`和`showTaskWithId`等方法实现，用于查询任务的状态和详细信息。

#### 请求消息: GetTaskHistoryRequest
该消息用于获取过滤后的任务历史记录。
- `metadata`: [Metadata](file://proto/cline/common.proto#L10-L12)
- `favorites_only`: bool - 是否仅返回收藏的任务。
- `search_query`: string - 用于搜索任务文本的查询字符串。
- `sort_by`: string - 排序字段（如时间戳）。
- `current_workspace_only`: bool - 是否仅返回当前工作区的任务。

#### 响应消息: TaskHistoryArray
该消息包含一个任务列表。
- `tasks`: repeated [TaskItem](file://proto/cline/task.proto#L85-L97) - 匹配查询条件的任务项数组。
- `total_count`: int32 - 符合条件的总任务数。

#### TaskItem 消息
`TaskItem`描述了任务历史中的单个条目。
- `id`: string - 任务唯一标识符。
- `task`: string - 任务的原始文本。
- `ts`: int64 - 任务创建的时间戳。
- `is_favorited`: bool - 任务是否被收藏。
- `size`: int64 - 任务的大小（字节）。
- `total_cost`: double - 任务的总成本。
- `tokens_in`, `tokens_out`: int32 - 输入和输出的token数量。
- `cache_writes`, `cache_reads`: int32 - 缓存写入和读取次数。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L15-L116)

## FileService 服务详解
`FileService`提供了一系列用于与文件系统交互的方法。

### ReadFile 操作
`ReadFile`操作由`openFile`和`openFileRelativePath`方法实现，用于在编辑器中打开文件。

#### 请求消息: StringRequest
- `value`: string - 要打开的文件的绝对路径或相对路径。

#### 响应消息: Empty
返回`Empty`，表示文件已成功在编辑器中打开。

### WriteFile 操作
`FileService`本身不直接提供`WriteFile`方法。文件的写入通常由任务执行过程中的内部逻辑或`TaskService`的`newTask`方法（通过`files`字段）间接触发。

### ListFiles 操作
`ListFiles`操作由`searchFiles`方法实现，用于在工作区中搜索文件。

#### 请求消息: FileSearchRequest
- `metadata`: [Metadata](file://proto/cline/common.proto#L10-L12)
- `query`: string - 搜索查询字符串。
- `mentions_request_id`: optional string - 用于跟踪请求的ID。
- `limit`: optional int32 - 返回结果的最大数量（默认20）。
- `selected_type`: optional [FileSearchType](file://proto/cline/file.proto#L30-L33) - 过滤类型（文件或文件夹）。

#### 响应消息: FileSearchResults
- `results`: repeated [FileInfo](file://proto/cline/file.proto#L73-L78) - 搜索结果列表。
- `mentions_request_id`: optional string - 回显的请求ID。

#### FileInfo 消息
- `path`: string - 相对于工作区根目录的路径。
- `type`: string - "file" 或 "folder"。
- `label`: optional string - 用于显示的名称（通常是文件名）。

**Section sources**
- [file.proto](file://proto/cline/file.proto#L15-L186)

## StateService 服务详解
`StateService`用于获取和更新Cline的全局状态和用户偏好设置。

### GetState 方法
`GetState`由`getLatestState`和`subscribeToState`方法实现。

#### 请求消息: EmptyRequest
无参数。

#### 响应消息: State
- `state_json`: string - 包含当前Cline状态的JSON字符串。

#### 流式响应: subscribeToState
此方法返回一个`State`消息流，允许客户端实时监听状态变化。

### UpdateState 方法
`UpdateState`由多个方法实现，用于更新不同的设置。

#### 请求消息示例: UpdateSettingsRequest
该消息用于更新各种设置。
- `metadata`: [Metadata](file://proto/cline/common.proto#L10-L12)
- `api_configuration`: optional [ApiConfiguration](file://proto/cline/state.proto#L170-L349) - 更新API配置。
- `telemetry_setting`: optional string - 更新遥测设置。
- `plan_act_separate_models_setting`: optional bool - 设置计划和执行是否使用不同模型。
- `browser_settings`: optional [BrowserSettingsUpdate](file://proto/cline/state.proto#L154-L161) - 更新浏览器设置。

#### 响应消息: Empty
返回`Empty`，表示状态已成功更新。

**Section sources**
- [state.proto](file://proto/cline/state.proto#L15-L290)

## ModelsService 服务详解
`ModelsService`负责管理可用的AI模型和API配置。

### ListModels 方法
`ListModels`由`refreshOpenRouterModels`、`refreshOpenAiModels`等方法实现。

#### 请求消息: EmptyRequest (以 refreshOpenRouterModels 为例)
无参数。

#### 响应消息: OpenRouterCompatibleModelInfo
- `models`: map<string, [OpenRouterModelInfo](file://proto/cline/models.proto#L55-L74)> - 以模型ID为键的模型信息映射。

#### OpenRouterModelInfo 消息
- `max_tokens`: optional int64 - 模型支持的最大输出token数。
- `context_window`: optional int64 - 模型的上下文窗口大小。
- `supports_images`: bool - 是否支持图像输入。
- `supports_prompt_cache`: bool - 是否支持提示缓存。
- `input_price`, `output_price`: optional double - 输入和输出的价格（每百万token）。
- `thinking_config`: optional [ThinkingConfig](file://proto/cline/models.proto#L38-L43) - 思考/推理配置。

### GetModelInfo 方法
`GetModelInfo`的功能包含在`ListModels`的响应中。`OpenRouterModelInfo`消息本身就提供了特定模型的详细信息。

**Section sources**
- [models.proto](file://proto/cline/models.proto#L15-L349)

## CheckpointsService 服务详解
`CheckpointsService`用于管理开发过程中的检查点。

### CreateCheckpoint 方法
`CreateCheckpoint`由`checkpointDiff`方法实现，它通过创建一个差异来标记一个检查点。

#### 请求消息: Int64Request
- `value`: int64 - 与检查点关联的数值（可能用于标识）。

#### 响应消息: Empty
返回`Empty`，表示检查点已成功创建。

### RestoreCheckpoint 方法
`RestoreCheckpoint`由`checkpointRestore`方法实现。

#### 请求消息: CheckpointRestoreRequest
- `metadata`: [Metadata](file://proto/cline/common.proto#L10-L12)
- `number`: int64 - 要恢复的检查点编号。
- `restore_type`: string - 恢复类型（如"full", "code_only"）。
- `offset`: optional int64 - 恢复操作的偏移量。

#### 响应消息: Empty
返回`Empty`，表示恢复操作已成功启动。

**Section sources**
- [checkpoints.proto](file://proto/cline/checkpoints.proto#L7-L18)

## 服务协同工作流程
这些服务协同工作以执行复杂的开发任务。一个典型的流程如下：
1. **初始化**: 客户端调用`ModelsService.refreshOpenRouterModels()`获取可用模型列表。
2. **配置**: 使用`StateService.updateSettings()`设置首选模型和参数。
3. **任务创建**: 调用`TaskService.newTask()`提交一个新任务。
4. **状态监控**: 通过`StateService.subscribeToState()`的流式连接实时监控任务状态。
5. **文件操作**: 在任务执行过程中，`FileService`的方法（如`searchFiles`）被内部调用以查找和操作文件。
6. **检查点管理**: 用户可以随时调用`CheckpointsService.checkpointDiff()`创建检查点，并在需要时通过`checkpointRestore()`恢复。

**Section sources**
- [task.proto](file://proto/cline/task.proto#L15-L116)
- [file.proto](file://proto/cline/file.proto#L15-L186)
- [state.proto](file://proto/cline/state.proto#L15-L290)
- [models.proto](file://proto/cline/models.proto#L15-L349)
- [checkpoints.proto](file://proto/cline/checkpoints.proto#L7-L18)

## TypeScript 调用示例
以下示例展示了如何使用TypeScript调用这些服务。

### 执行任务
```typescript
// 创建新任务
const newTaskRequest = new NewTaskRequest();
newTaskRequest.setText("在src目录下创建一个名为'utils.ts'的新文件，并导出一个名为'helloWorld'的函数。");
newTaskRequest.setImages([]);
newTaskRequest.setFiles([]);

taskService.newTask(newTaskRequest, (error, response) => {
  if (error) {
    console.error("任务创建失败:", error);
    return;
  }
  console.log("任务已创建，正在监控状态...");
  
  // 订阅状态更新
  const stateStream = stateService.subscribeToState(new EmptyRequest());
  stateStream.on('data', (state: State) => {
    console.log("状态更新:", state.getStateJson());
  });
  stateStream.on('error', (err) => {
    console.error("状态流错误:", err);
  });
});
```

### 列出文件
```typescript
// 搜索文件
const fileSearchRequest = new FileSearchRequest();
fileSearchRequest.setQuery("utils");
fileSearchRequest.setLimit(10);

fileService.searchFiles(fileSearchRequest, (error, response) => {
  if (error) {
    console.error("文件搜索失败:", error);
    return;
  }
  const results = response.getResultsList();
  results.forEach(fileInfo => {
    console.log(`找到文件: ${fileInfo.getPath()}`);
  });
});
```

### 获取模型信息
```typescript
// 获取OpenRouter模型
modelsService.refreshOpenRouterModels(new EmptyRequest(), (error, response) => {
  if (error) {
    console.error("获取模型失败:", error);
    return;
  }
  const modelsMap = response.getModelsMap();
  modelsMap.forEach((modelInfo, modelId) => {
    console.log(`模型: ${modelId}, 上下文: ${modelInfo.getContextWindow()}`);
  });
});
```

### 创建检查点
```typescript
// 创建检查点
const checkpointRequest = new Int64Request();
checkpointRequest.setValue(1); // 检查点编号

checkpointsService.checkpointDiff(checkpointRequest, (error, response) => {
  if (error) {
    console.error("创建检查点失败:", error);
    return;
  }
  console.log("检查点已创建");
});
```

**Section sources**
- [task.proto](file://proto/cline/task.proto#L15-L116)
- [file.proto](file://proto/cline/file.proto#L15-L186)
- [models.proto](file://proto/cline/models.proto#L15-L349)
- [checkpoints.proto](file://proto/cline/checkpoints.proto#L7-L18)

## 附录：核心消息类型
本节列出在多个服务中复用的核心消息类型。

### Metadata
所有请求消息的通用元数据。
- `metadata`: [Metadata](file://proto/cline/common.proto#L10-L12) - 无具体字段，占位符。

### EmptyRequest 和 Empty
用于无参数请求和无内容响应。
- `EmptyRequest`: [EmptyRequest](file://proto/cline/common.proto#L14-L16)
- `Empty`: [Empty](file://proto/cline/common.proto#L18-L20)

### StringRequest
用于传递单个字符串值。
- `value`: string - 字符串值。

**Section sources**
- [common.proto](file://proto/cline/common.proto#L10-L98)