# 成本跟踪

<cite>
**本文档中引用的文件**  
- [cost.ts](file://src/utils/cost.ts)
- [retry.ts](file://src/core/api/retry.ts)
- [TelemetryService.ts](file://src/services/telemetry/TelemetryService.ts)
- [CreditBalance.tsx](file://webview-ui/src/components/account/CreditBalance.tsx)
</cite>

## 目录
1. [简介](#简介)
2. [成本计算核心模块](#成本计算核心模块)
3. [API调用中的成本数据收集](#api调用中的成本数据收集)
4. [成本数据上报与分析](#成本数据上报与分析)
5. [用户信用额度与使用历史查看](#用户信用额度与使用历史查看)
6. [典型任务成本计算示例](#典型任务成本计算示例)

## 简介
本文档详细说明Cline系统中成本跟踪功能的实现机制。重点阐述系统如何计算不同LLM提供商（如Anthropic、OpenAI）的令牌使用量和API费用，描述成本数据在API调用过程中的收集与累加机制，以及如何通过遥测服务将数据上报用于分析。同时，文档还解释了用户如何在UI界面中查看其信用额度和使用历史。

## 成本计算核心模块

`cost.ts` 模块是Cline成本跟踪系统的核心，负责根据不同的LLM提供商计算API调用的费用。该模块通过 `ModelInfo` 接口获取模型的定价信息，并根据输入和输出的令牌数量计算总成本。

模块支持两种主要的计费模式：Anthropic模式和OpenAI模式。在Anthropic模式下，输入令牌计数不包括缓存令牌；而在OpenAI模式下，输入令牌计数包括缓存令牌。模块还支持分层定价，根据总输入令牌数量查找相应的价格层级。

**Section sources**
- [cost.ts](file://src/utils/cost.ts#L1-L113)

## API调用中的成本数据收集

在API调用过程中，成本数据的收集和累加主要通过 `retry.ts` 模块实现。该模块使用装饰器模式为API调用方法添加重试功能，并在每次调用时收集相关的成本信息。

当API调用发生时，系统会捕获输入和输出的令牌数量，并将这些数据传递给成本计算模块。如果调用失败并触发重试机制，系统会确保成本数据在多次尝试中正确累加，避免重复计算或遗漏。

**Section sources**
- [retry.ts](file://src/core/api/retry.ts#L1-L87)

## 成本数据上报与分析

成本数据通过 `TelemetryService.ts` 模块上报用于分析和展示。该服务负责收集和发送各种遥测事件，包括令牌使用情况、任务完成情况和用户交互等。

当一次API调用完成时，系统会调用 `captureConversationTurnEvent` 方法，将令牌使用数据（包括输入、输出、缓存读写令牌数量和总成本）作为属性包含在遥测事件中。这些数据随后被发送到分析后端，用于生成使用报告和成本分析。

遥测服务还支持按类别控制数据收集，确保用户隐私得到尊重。成本相关数据主要通过 `TOKEN_USAGE` 和 `CONVERSATION_TURN` 事件进行上报。

**Section sources**
- [TelemetryService.ts](file://src/services/telemetry/TelemetryService.ts#L1-L799)

## 用户信用额度与使用历史查看

用户可以通过UI界面查看其信用额度和使用历史。`CreditBalance.tsx` 组件负责在账户页面显示当前余额信息。

该组件显示用户的当前信用余额，并提供刷新按钮以获取最新余额。用户还可以通过"Add Credits"链接跳转到充值页面。余额显示采用专门的 `StyledCreditDisplay` 组件进行格式化，确保信息清晰易读。

虽然具体的使用历史查看功能未在提供的代码片段中体现，但可以推断系统会通过类似的UI组件展示详细的使用记录，包括每次任务的令牌消耗和费用明细。

**Section sources**
- [CreditBalance.tsx](file://webview-ui/src/components/account/CreditBalance.tsx#L1-L41)

## 典型任务成本计算示例

以下是一个典型任务的完整成本计算过程示例：

1. 用户发起一个任务，系统选择使用OpenAI的GPT-4模型
2. API调用包含8000个输入令牌（其中1000个为缓存令牌）和2000个输出令牌
3. 系统调用 `calculateApiCostOpenAI` 函数进行成本计算
4. 函数计算非缓存输入令牌为7000个（8000-1000）
5. 根据GPT-4的定价（假设输入$0.01/1K令牌，输出$0.03/1K令牌）
6. 输入成本：7000 * ($0.01/1000) = $0.07
7. 输出成本：2000 * ($0.03/1000) = $0.06
8. 缓存写入成本：1000 * ($0.001/1000) = $0.001
9. 总成本：$0.07 + $0.06 + $0.001 = $0.131
10. 系统将此成本数据通过遥测服务上报，并更新用户界面显示

此示例展示了从API调用到成本计算再到数据上报的完整流程，体现了Cline成本跟踪系统的完整工作机制。

**Section sources**
- [cost.ts](file://src/utils/cost.ts#L1-L113)
- [TelemetryService.ts](file://src/services/telemetry/TelemetryService.ts#L1-L799)
- [retry.ts](file://src/core/api/retry.ts#L1-L87)
- [CreditBalance.tsx](file://webview-ui/src/components/account/CreditBalance.tsx#L1-L41)